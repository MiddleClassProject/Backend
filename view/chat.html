<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Interface</title>
    <link href="./chat_style.css" rel="styles.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@100;200;300;400;500;600;700;800;900&amp;display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
    />
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <style>
      * {
        background-color: #fffef5;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }

      body {
        display: flex;
        height: 100vh;
        background-color: #fffef5;
      }

      .sidebar {
        width: 260px;
        background-color: #fffef5;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .chat-list {
        list-style: none;
        padding: 8px;
        background-color: #fffef5;
      }

      .chat-item {
        padding: 12px;
        margin-bottom: 4px;
        cursor: pointer;
        border-radius: 8px;
        transition: background-color 0.2s;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #ffffff;
      }

      .chat-header {
        padding: 16px;
        border-bottom: 1px solid #e5e7eb;
      }

      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }

      .message {
        max-width: 80%;
        width: fit-content;
        margin-bottom: 16px;
        padding: 12px;
        border-radius: 8px;
        line-height: 1.5;
        word-break: break-all;
      }

      .message.received {
        background-color: #f3f4f6;
        margin-right: auto;
        text-align: left;
        display: flex;
        flex-direction: column;
      }

      .input-container {
        padding: 16px;
        border-top: 1px solid #e5e7eb;
      }

      .message-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        resize: none;
        outline: none;
        font-size: 14px;
      }

      .message-input:focus {
        border-color: #0084ff;
      }

      #chat_container {
        display: flex;
        justify-content: center;
      }

      #chat_container button {
        padding: 10px 20px;
        border: none;
        background-color: #989085;
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }

      #chat_container button:hover {
        background-color: #c0b5a7;
      }

      .hidden {
        display: none;
        width: 400px;
      }

      #chatForm {
        display: flex;
        width: 80%;
        height: 40px;
        gap: 10px;
      }
      .shadow-thin {
        box-shadow: 0 1px 1px rgba(100, 100, 100, 0.8);
      }
      #content {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-right: 10px;
      }
      #message {
        height: 800px;
        background-color: #fffef5;
        padding: 0;
        margin: 0;
        overflow-y: auto;
      }
      .me {
        text-align: right;
        display: flex;
        justify-content: right;
      }
      .other {
        text-align: left;
        display: flex;
        flex-direction: column;
      }
      #chatHeader {
        background-color: #f3f4f6;
        border-bottom: 1px solid #e5e7eb;
      }

      #nicknameDisplay {
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }
      .nickname {
        width: fit-content;
        font-weight: bold;
        color: #555;
        margin-bottom: 4px;
      }
      .msg {
        width: fit-content;
        max-width: 20ch;
        word-wrap: break-word;
        white-space: normal;
        padding: 7px;
        background-color: #c9c0ae;
        color: white;
        border-radius: 5px;
      }

      .hidden {
        display: none;
        width: 793px;
        height: 40px;
      }

      .px-4 {
        color: black;
      }

      .chat-item:hover,
      .chat-item.active {
        background-color: #e9e3d3;
      }
      #messagesContainer {
        height: calc(100vh - 160px);
        overflow-y: auto;
      }
      .message {
        max-width: 80%;
        margin-bottom: 16px;
        padding: 12px;
        border-radius: 8px;
        line-height: 1.5;
        box-shadow: 0 1px 1px rgba(100, 100, 100, 0.8);
      }
      .message.received {
        background-color: #eeefea;
        margin-right: auto;
      }
      .message.sent {
        background-color: #c9c0ae;
        color: white;
        margin-left: auto;
      }

      #paid {
        width: 40px;
        height: 40px;
        font-size: 30px;
        line-height: 40px;
        color: #989085;
        cursor: pointer;
      }
      #paid:hover {
        color: #c0b5a7;
      }
      #paymentModal {
        display: none;
        justify-content: center; /* 가로 중앙 정렬 */
        align-items: center; /* 세로 중앙 정렬 */
        width: 100%;
        height: 860px !important;
        text-align: center; /* 텍스트 중앙 정렬 */
        flex-direction: column; /* 버튼 아래 배치 */
        z-index: 2; /* 오버레이보다 앞쪽 */
      }
      .ui-dialog-titlebar {
        display: none;
      }
      #payment {
        display: flex;
        width: 300px;
        height: 70px;
        background-color: whitesmoke;
        flex-direction: column;
        justify-content: space-around;
        align-items: center;
        border-radius: 10px;
        box-shadow: 0 10px 10px rgba(100, 100, 100, 0.4);
      }
      #payChoice {
        width: 200px;
        display: flex;
        text-align: center;
        font-size: 15px;
        justify-content: space-around;
        gap: 10px;
      }
      #payChoice button {
        width: 100px;
        border: 1px rgba(200, 200, 200, 0.4) solid;
        border-radius: 5px;
        font-size: 15px;
        line-height: 20px;
        text-align: center;
      }
      #payChoice button:hover {
        background-color: #dfc2c4;
      }
      .ui-widget-overlay {
        z-index: 9999; /* 오버레이를 최상위로 */
      }
      .ui-dialog {
        width: 100% !important;
        height: 860px !important;
        /* top: 120px; */
        margin: 0;
        padding: 0;
        position: absolute;
        background-color: rgba(100, 100, 100, 0.4);
        z-index: 10000; /* 오버레이를 최상위로 */
      }
      /* 내부 컨텐츠 크기 조절 가능 */
      .ui-dialog-content {
        display: flex;
        justify-content: center; /* 가로 중앙 정렬 */
        align-items: center; /* 세로 중앙 정렬 */
        width: 100%;
        height: 100%; /* 부모의 높이에 맞추기 */
        text-align: center; /* 텍스트 중앙 정렬 (선택 사항) */
        padding: 20px;
      }
      .hidden {
        display: none;
        width: 793px;
        height: 40px;
      }
      .modal {
        display: flex;
        justify-content: center;
        align-items: center;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal.hidden {
        display: none;
      }

      .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        width: 300px;
        text-align: center;
      }

      .amount-display {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0;
      }

      .amount-buttons button,
      .keypad button,
      .next-btn,
      .close-btn {
        margin: 5px;
        padding: 10px 15px;
        font-size: 16px;
        border: none;
        border-radius: 4px;
        background-color: #f3f4f6;
        cursor: pointer;
      }

      .amount-buttons button:hover,
      .keypad button:hover,
      .next-btn:hover,
      .close-btn:hover {
        background-color: #ddd;
      }

      .password-dots span {
        display: inline-block;
        width: 10px;
        height: 10px;
        margin: 0 5px;
        background-color: #ccc;
        border-radius: 50%;
      }
      .password-dots span.filled {
        background-color: #0084ff;
      }

      .payment-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 300px;
        padding: 20px;
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10000;
      }

      .payment-popup h3 {
        margin-bottom: 16px;
        font-size: 18px;
        text-align: center;
      }

      .payment-popup label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .payment-popup input {
        width: 100%;
        padding: 8px;
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
      }

      .payment-popup button {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        border: none;
        border-radius: 4px;
        background-color: #0084ff;
        color: #ffffff;
        cursor: pointer;
      }

      .payment-popup button:hover {
        background-color: #0056cc;
      }

      .loading {
        text-align: center;
        font-size: 16px;
        color: #555;
      }
    </style>
  </head>
  <body class="flex h-screen">
    <div
      class="border-r border-gray-200 flex flex-col overflow-y-auto"
      style="width: 20%"
    >
      <div class="chat-list p-2">
        <!-- <div class="chat-item p-3 mb-1 cursor-pointer rounded-lg transition-colors" onclick="selectChat(this, '그냥자고싶어용')">그냥자고싶어용</div>
            <div class="chat-item p-3 mb-1 cursor-pointer rounded-lg transition-colors" onclick="selectChat(this, '채팅2')">채팅2</div>
            <div class="chat-item p-3 mb-1 cursor-pointer rounded-lg transition-colors" onclick="selectChat(this, '채팅3')">채팅3</div> -->
      </div>
    </div>
    <div id="mainContent" class="flex-1 flex flex-col bg-white hidden">
      <div class="p-4 border-b border-gray-200">
        <h2 id="chatTitle" class="text-xl font-semibold">채팅방</h2>
      </div>
      <div id="messagesContainer" class="flex-1 p-5 bg-[#FFFEF5]">
        <div id="chatHeader" class="flex items-center p-4 bg-gray-100 border-b">
          <span
            id="nicknameDisplay"
            class="font-bold text-lg text-gray-700"
          ></span>
        </div>
      </div>
      <div id="paymentModal">
        <div id="payment">
          <span>결제를 요청하시겠습니까?</span>
          <div id="payChoice">
            <button id="confirmYes">예</button>
            <button id="confirmNo">아니요</button>
          </div>
        </div>
      </div>
      <div class="border-t border-gray-200 p-4">
        <div id="chat_container">
          <form id="chatForm" class="flex">
            <i id="paid" class="fa-solid fa-credit-card"></i>
            <input
              id="messageInput"
              type="text"
              class="shadow-thin flex-grow p-2 border border-gray-300 rounded-l-lg"
              placeholder="메시지를 입력하세요"
            />
            <button type="submit" class="shadow-thin">전송</button>
          </form>
        </div>
      </div>
      <div
        id="placeholderContent"
        class="flex-1 flex items-center justify-center text-gray-500"
      ></div>
    </div>
  </body>
  <script>
    /*소켓 통신*/
    //===========================================

    var socket = io();
    var currentChat = null;
    var nickname = getCookie("user_id");
    let pro_id, pro_name;
    let user_name;
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      socket.emit("join", parts[1]);

      if (parts.length === 2) return parts.pop().split(";").shift();
      return null;
    }

    if (!nickname) {
      alert("로그인을 해주세요");
    }

    function selectChat(element, chatName, room_id) {
      $(".chat-item").removeClass("active");
      $(element).addClass("active");
      currentChat = chatName;
      $("#chatTitle").text(chatName);
      $("#mainContent").removeClass("hidden");
      $("#placeholderContent").addClass("hidden");
      $("#messagesContainer").empty(); // Clear previous messages

      getChat(room_id);
    }

    socket.on("msg", function (data) {
      if (currentChat) {
        const messageElement = $("<div>").addClass("message");

        if (data.msg.includes("<button")) {
          messageElement.html(data.msg); // HTML 메시지
        } else {
          messageElement.text(data.msg); // 일반 텍스트 메시지
        }

        if (data.nickname === nickname) {
          messageElement.addClass("sent");
        } else {
          $("#nicknameDisplay").text(data.nickname); // 상대방 닉네임 표시
          receivedNicknameSet = true;

          messageElement.addClass("received");
        }

        $("#messagesContainer").append(messageElement);
        $("#messagesContainer").scrollTop(
          $("#messagesContainer")[0].scrollHeight
        );
      }
    });

    $("form").submit(function (e) {
      e.preventDefault();
      const message = $("#messageInput").val();
      if (message && currentChat) {
        socket.emit("msg", message);
        $("#messageInput").val("");
      }
    });

    /*모달*/
    //===========================================

    $(document).ready(function () {
      // 모달 열기
      $("#paymentModal").css("display", "none");
      $("#paid").click(function () {
        $("#paymentModal")
          .css("display", "flex")
          .dialog({
            modal: true, // 모달 설정
            open: function () {
              $('div[role="dialog"]').css("top", "0px");
            },
            // resizable: true, // 크기 조정 가능
            // draggable: false, // 이동 불가
            width: "auto", // 내부 컨텐츠에 맞게 크기 자동 조정
            height: "860px",
            top: "30px",
            close: function () {
              $("#paymentModal").css("display", "none"); // 닫힐 때 display: none 설정
            },
          });
        // 외부 클릭으로 모달 닫기
        $(".ui-widget-overlay").on("click", function () {
          $("#paymentModal").dialog("close");
        });
      });

      // "예" 버튼 클릭
      $("#confirmYes").click(function () {
        sendPaymentRequest();
        $("#paymentModal").dialog("close"); // 모달 닫기
      });

      // "아니요" 버튼 클릭
      $("#confirmNo").click(function () {
        $("#paymentModal").dialog("close"); // 모달 닫기
      });
    });

    /*api 호출*/
    //==============================================================

    // 서버에서 데이터 가져오기
    fetch("/chat/list")
      .then((res) => res.json())
      .then((data) => {
        // 받은 데이터를 HTML로 렌더링
        renderChatRoomList(data);
      })
      .catch((error) => console.error("Error fetching chat list:", error));

    // DOM에 채팅 리스트 추가하는 함수
    function renderChatRoomList(chatData) {
      const chatListContainer = document.querySelector(".chat-list"); // chat-list 컨테이너 선택

      // 받은 객체 배열을 반복하며 각 데이터를 div로 생성
      chatData.result.forEach((chat) => {
        // 새 div 생성
        let name;
        pro_id = chat.cus1; //cus1이 무조건 교수
        pro_name = chatData.name[0].proname;
        user_name = chatData.name[0].cusname;
        const chatItem = document.createElement("div");
        chatItem.className =
          "chat-item p-3 mb-1 cursor-pointer rounded-lg transition-colors";

        //상대방의 화면이 뜨도록 하기.
        if (nickname == chat.cus1) {
          name = chatData.name[0].cusname;

          chatItem.textContent = name || "No Name"; // 채팅 데이터에서 이름 표시
        } else {
          name = chatData.name[0].proname;

          chatItem.textContent = name || "No Name"; // 채팅 데이터에서 이름 표시
        }

        chatItem.setAttribute(
          "onclick",
          `selectChat(this, ${JSON.stringify(name)}, ${chat.room_id})`
        );

        // 컨테이너에 추가
        chatListContainer.appendChild(chatItem);
      });
    }

    function getChat(room_id) {
      fetch(`/chat/detail/${room_id}`)
        .then((res) => res.json())
        .then((data) => {
          // 받은 데이터를 HTML로 렌더링
          renderChatList(data.data);
        })
        .catch((error) => console.error("Error fetching chat list:", error));
    }

    function renderChatList(chat) {
      let receivedNicknameSet = false; // 닉네임이 상단에 표시되었는지 확인

      chat.forEach((data) => {
        const messageElement = $("<div>").addClass("message");

        // 메시지 내용 렌더링
        if (data.chat_message.includes("<button")) {
          messageElement.html(data.chat_message); // HTML로 렌더링
        } else {
          messageElement.text(data.chat_message); // 일반 텍스트로 렌더링
        }

        // 수신 메시지 처리
        if (data.cus_id != nickname) {
          messageElement.addClass("received");

          // 닉네임이 아직 상단에 표시되지 않았다면 설정
          if (!receivedNicknameSet) {
            $("#nicknameDisplay").text(data.cus_id); // 상대방 닉네임 표시
            receivedNicknameSet = true;
          }
        } else {
          // 송신 메시지 처리
          messageElement.addClass("sent");
        }

        // 메시지 추가
        $("#messagesContainer").append(messageElement);
        $("#messagesContainer").scrollTop(
          $("#messagesContainer")[0].scrollHeight
        );
      });
    }

    //결제창 팝업
    //==============================================
    // 채팅 메시지에 결제 요청 링크 버튼 삽입
    function sendPaymentRequest() {
      const paymentLink = "http://localhost:3000/chat/payment";
      const paymentMessage = `
    <button class="payment-link" data-link="${paymentLink}" style="">
      결제를 진행하려면 여기를 클릭하세요
    </button>
  `;

      // 메시지 전송
      socket.emit("msg", paymentMessage);

      // 채팅창 숨김
      $(".chat-container").addClass("inactive");
    }

    // 결제 버튼 클릭 시
    $(document).on("click", ".payment-link", function () {
      const link = $(this).data("link");
      $(".chat-container").addClass("inactive"); // CSS 클래스 추가
      const popup = window.open(link, "paymentPopup", "width=400,height=600");

      popup.addEventListener("load", () => {
        popup.postMessage({ pro_name, user_name}, "*"); // 팝업 창으로 메시지 전달
      });
    });

    // 결제 완료 후 다시 채팅창 활성화
    function paymentCompleted(message) {
      if (currentChat) {
        socket.emit("msg", message); // 상대방에게 메시지 전송
        $(".chat-container").removeClass("inactive"); // CSS 클래스 제거
      } else {
        console.log("채팅방이 선택되지 않았습니다.");
      }
    }
  </script>
</html>
